# School-CI: непрерывная интеграция - ни один коммит не уйдет не собранным. 

> Версия node: v12.16.2

## Начало работы:
1. Клонировать репозиторий с проектом;
2. В командной строке перейти в директорию проекта и переключится на ветку задания, которая была написана в тикете:
```bash
% git checkout NAME_OF_BRANCH
```

## Предварительная настройка: 
1. Перейти в поддиректорию `./server`;
2. Создать файл `.env` в корне поддиректории;
3. Добавить в файл следующий текст:
```txt
SECRET_KEY = 'Bearer YOUR_SECRET_KEY'
NODE_TLS_REJECT_UNAUTHORIZED = '0'
```

4. Убедиться, что файл сохранен, а значение SECRET_KEY начинается с Bearer<пробел>;
5. Перейти к запуску проекта.

## Запуск проекта: 
1. В командной строке перейти в директорию проекта и запустить команды последовательно: 
  - Предварительная установка пакетов:
```bash
% npm i
``` 
  - Установка пакетов в поддиректориях `./client` и `./server`:
```bash
% npm run postinstall
```
  - Запуск серверов (client - порт 3000, server - порт 3001):
```bash
% npm run start
```
2. ...
3. PROFIT! Проект запущен и автоматически открылся в вашем браузере по адресу [http://localhost:3000](http://localhost:3000).

## Домашнее задание: инфраструктура

#### Выполнение требований
- ***Сервер должен максимально утилизировать имеющихся агентов.***

> **Решение:** по свободным агентам запускается цикл, что не допускает простоя. Смотреть функцию `sendToBuilding` в `./server/controllers.js`;
- ***Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать между сборками.***

> **Решение:** Корректной ситуацией считаю, что сервер должен удалить неработающего агента из списка доступных агентов. Здесь отрабатывают два сценария: 
> 1. функция `sendToBuilding` просто скипает агента, если тот не ответил на отправку ему сборки;
> 2. функция `checkFreezingProcesses` (в `./server/controllers.js`) по таймеру пингует всех зарегистрированных агентов, в случае их недоступности - выкидывает из списка доступных;

- ***Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать в процессе выполнения сборки.***

> **Решение:** функция `checkFreezingProcesses` (в `./server/controllers.js`) по таймеру пингует всех зарегистрированных агентов, в случае их недоступности - выкидывает из списка доступных и изменяет статус сборки, которая была передана агенту на "Waiting", что помещает ее обратно в начало очереди;

- ***Агент должен корректно обрабатывать ситуацию, когда при старте не смог соединиться с сервером.***

> **Решение:** корректной ситуацией будет циклический повтор попытки регистрации на сервере, что реализовано;

- ***Агент должен корректно обрабатывать ситуацию, когда при отправке результатов сборки не смог соединиться с сервером.***

> **Решение:** корректной ситуацией будет циклический повтор отправки результатов, т.к. это прямая задача агента. Реализовано;

**Дополнительно:** Также, корректно было бы во всех вышеописанных случаях, уведомлять системного администратора о недоступности агента или сервера после заданного количества неуспешных попыток соединения с сервером или агентами;

### Логика приложения
#### Server
1. При запуске сервера идет запрос на получение настроек и выполняется до тех пор, пока настройки не получены, т.к. без них деятельность сервера невозможна;
2. Запускается цикл для получения очереди билдов. При получении очереди следующая итерация повторяется только тогда, когда ранее полученная очередь очищена (т.е. все сборки выполнены);
3. Регистрирует агентов и сохраняет их в отдельную очередь;
4. При наличии билдов в очереди и свободных агентов, запускает цикл для распределения билдов по свободным агентам;

#### Agent
1. При запуске идет уведомление сервера (циклическое на случай неответа);
2. Сборка: перед и после начала сборки запускается функция очистки директории, в которую клонируется репозиторий. Запускается два раза, на случай, если до этого агент упал во время сборки и склонированное не было удалено;


