# ШРИ-2020. Домашнее задание Node.js

## Установка и запуск:
1. Склонировать или сохранить репозиторий;
```bash
$ git clone https://github.com/Wansmer/School-CI.git
```
2. Перейти в директорию проекта `/server`;
```bash
$ cd server
```
3. Установить пакеты и зависимости:
```bash
$ npm i
```
4. Запустить локальный сервер:
```bash
$ npm run listen
```
Сервер запустится на порту 3000.

## Предварительная настройка:
1. Для авторизации запросов нужно добавить в переменную окружения `process.env.SECRET_KEY` значение со своим ключом, которое должно выглядить как `Bearer<пробел><ключ>`. Так же можно добавить значение ключа в константу `headers`, которая находится в файле `./constants.js`;

2. В файл `./constants.js` в константу `GIT_PATH` нужно записать ссылку на аккаунт на github, с которого будут проводиться тесты;

3. Возможна проблема с подтверждением сертификата по адресу сервера (https://hw.shri.yandex/api/), поэтому нужно отключить проверку сертификатов в node.
```js
// .constants.js
exports.BASE_URL  = 'https://hw.shri.yandex/api/';
exports.GIT_PATH = 'https://github.com/Wansmer/';
exports.headers = {
  accept: 'application/json',
  Authorization: process.env.SECRET_KEY
};
```

## Логика приложения:
* При добавлении настроек в поддиректории `./server/clone` создается папка с названием репозитория и запускается его клонирование с github.com;
* При отправке post запроса по адресу [localhost:3000/builds/:commitHash](localhost:3000/builds/:commitHash) запускается дочерний процесс, который последовательно 
  1. Устанавливает npm пакеты согласно package.json репозитория;
  2. Перемещает HEAD на указанный в post запросе коммит;
  3. Отправляет данные о старте на сервер;
  3. Запускает сборку проекта;
  4. Отправляет данные об окончании сборки на сервер;
  5. Завершает дочерний процесс;
  6. Запускает таймер синхронизации после сигнала о завершении процесса;

## Над чем работа еще не завершена:
- Реализация очереди процессов ожидается в будущих коммитах;
- Подключение таймера;
- Парсинг имени ветки с единственным значением;
- Проход по истории коммитов для добавления процессов сборки в очередь;

## Баги:
- При переключении ветки сборка осуществляется только со второго пост-запроса;
- Дочерний процесс иногда не завершается - пока не понял причину, но, возможно, это особенности реализации `express.js`;

## Отдача статики: 
На данный момент сделал отображение главной страницы, страницы с настройками и страницу истории коммитов через `pug` c подстановкой результатов из DB. Т.е. со станицы `/settings` можно сохранять реальные настройки. 

Отдача статики на данный момент не предполагает окончание запроса на `.html`;

## Структура проекта:
```
/api - функционал обращений к DB;
/app - функционал для осуществления сборки и файлы процессов для fork;
/clone - папка, куда устанавливается репозиторий;
/routes - роутер для запросов к приложению;
/static - стили и js для клиента;
/views - файлы шаблонизатора для рендеринга статики;
constants.js - файл с константами;
server.js - сервер;
```

## Инструменты:
- node framework 